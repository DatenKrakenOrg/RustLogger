global
    log stdout local0
    maxconn 4096
    stats socket ipv4@*:9999 user haproxy group haproxy mode 660 level admin
    stats timeout 30s

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout check 2000ms

# Elasticsearch frontend and backend
frontend elasticsearch_front
    bind *:9200
    option forwardfor
    default_backend elasticsearch

backend elasticsearch
    balance roundrobin
    option forwardfor
    # Preserve headers and handle SSL properly
    http-request set-header X-Forwarded-Proto http
    http-request set-header X-Forwarded-Port 9200
    # Use simple TCP check instead of HTTP check due to authentication requirements
    server es01 es01:9200 check ssl verify none inter 10s rise 2 fall 3
    server es02 es02:9200 check ssl verify none inter 10s rise 2 fall 3
    server es03 es03:9200 check ssl verify none inter 10s rise 2 fall 3
    server es04 es04:9200 check ssl verify none inter 10s rise 2 fall 3
    server es05 es05:9200 check ssl verify none inter 10s rise 2 fall 3

# Statistics page
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

listen health_check_http_url
    bind *:8404
    mode http
    monitor-uri /healthz
    option      dontlognull
